#/bin/bash

help()
{
	echo 'Usage: tot [options]'
	echo 'start [-p port] [-b binding=ip]    Start TOT2 with port. Default port is 3000.'
	echo 'stop                               Stop TOT2.'
	echo 'setup                              Setup bundle and db of rails.'
	echo 'reset rootuser                     Recreate tot@tot.com and reset its password to totadmin.'
	echo 'reset db                           Remove all apps, all uploaded files, and all users'
}

starthelp()
{
	echo 'Usage: tot start [mongrel, thin, etc] [options]'
    echo '-p, --port=port                  Runs Rails on the specified port.'
    echo '                                 Default: 3000'
    echo '-b, --binding=ip                 Binds Rails to the specified ip.'
    echo '                                 Default: 0.0.0.0'
    echo '-P, --pid=pid                    Specifies the PID file.'
    echo '                                 Default: tmp/pids/server.pid'
}

setup()
{
	path=`dirname $0`
	cd $path
	bundle install
	RAILS_ENV=production rake db:create
	RAILS_ENV=production rake db:migrate
	RAILS_ENV=production rake db:seed;
}

start()
{
	path=`dirname $0`
	cd $path
	shift
	RAILS_ENV=production rails server -d $@;
	sleep 1s
	if [[ -e ./tmp/pids/server.pid ]]; then
		echo 'TOT server started'
	else
		echo 'TOT server start failed, run rails s -e production for more info'
	fi
}

stop()
{
	path=`dirname $0`
	cd $path
	for i in `cat ./tmp/pids/server.pid`
	do
		kill -9 $i
		rm ./tmp/pids/server.pid
		echo 'TOT2 server stopped'
	done
}

rootuser()
{
	path=`dirname $0`
	cd $path
	RAILS_ENV=production rake db:seed;
}

resetdb()
{
	echo 'resetting db'
	path=`dirname $0`
	cd $path
	RAILS_ENV=production rake db:reset;
	rm -rf ./public/uploads/*
}


if [[ "$1" = "help" ]]; then
	help
elif [[ "$1" = "--help" ]]; then
	help
elif [[ "$1" = "setup" ]]; then
	setup
elif [[ "$1" = "reset" ]] && [[ "$2" = "rootuser" ]]; then
	rootuser
elif [[ "$1" = "reset" ]] && [[ "$2" = "db" ]]; then
	resetdb
elif [[ "$1" = "stop" ]]; then
	stop
elif [[ "$1" = "start" ]]; then
	if [[ "$2" = "help" ]]; then
		starthelp
	elif [[ "$2" = "--help" ]]; then
		starthelp
	else
		start $@
	fi
else
	help
fi